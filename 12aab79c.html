<html ng-app="ionicApp">

	<head>
		<meta charset="utf-8" id="device_id">
		<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">

		<title>HomeLink</title>
  <link href="http://api.easylink.io/bower_components/ionic/css/ionic.min.css" rel="stylesheet">
  <script src="http://api.easylink.io/bower_components/ionic/js/ionic.bundle.min.js"></script>
	<script type="text/javascript" src="js/new_file2.js"></script>
	
	<link rel="stylesheet" type="text/css" href="css/component.css" />
	<script src="js/snap.svg-min.js"></script>
	

		<link rel="stylesheet" type="text/css" href="./css/login.css"/>

	
  <style>
  	.divAlert{
	width:300px;
	border: 2px solid #37B6D1;
	font-weight: bold;
	font-size: 12px;
	left: 364px;
	top: 109px;
}
.divAlert_Title{ line-height:25px; padding:0px 5px;	background-color: #37B6D1;}
.divAlert_Content{background-color: #fff; line-height:80px; text-align:center; }
.divAlert_Btn{ text-align:center; padding:0px 0px 20px;background-color: #fff;  }
.btnSure{ border:1px solid #CCC; background-color:#CCC; width:50px; height:25px;}

		#page-1
		{
			margin-top:65px;
		}
    
    .size-12 { font-size: 12px; }
    .size-14 { font-size: 14px; }
    .size-16 { font-size: 16px; }
    .size-18 { font-size: 18px; }
    .size-21 { font-size: 21px; }
    .size-24 { font-size: 24px; }
    .size-32 { font-size: 32px; }
    .size-48 { font-size: 48px; }
    .size-64 { font-size: 64px; }
    .size-96 { font-size: 96px; }
    
  </style>
	</head>

	<body ng-controller="MyCtrl" style="background: url(./image/login.png) 50% 0 no-repeat;background-size: cover;">
	
		<div id="pagewrap" class="pagewrap">
		
			<div class="container show" id="page-1">
				<section>
					<div class="login" data-role="page" data-theme="f" id="loginpage">
						<div class="logocls" align="center">
							<img src="./image/login-micokit.svg" />
						</div>
						<br/>
						<div class="content">							
							<div style="margin-bottom: 30px;	height: 35px;	line-height: 35px;" >
								<img style="width: 28px;"  src="./image/account-tx.svg"/>
								<input class="styled" type="text" maxlength="20" style="border:0;border-bottom: 1px solid #3DB481;background:transparent;color:#3DB481;" data-theme="f" data-role="none" placeholder="请输入用户名" id="login_user">
							</div>
							<div style="margin-bottom: 30px;	height: 35px;	line-height: 35px;">
								<img style="width: 28px;"  src="./image/account-cd.svg"/>
								<input class="styled" type="password" maxlength="6" style="border:0;border-bottom: 1px solid #3DB481;background:transparent;color:#3DB481;" placeholder="请输入六位密码" id="login_psw">
							</div>
							<div class="subbutton pageload-link">
								<span><a href="#">登录</a></span>
							</div>
						</div>
		
						<div class="toregistcls">
							<div class="toregistbtn" onclick="changpswtag('registerpage')">
								<span ><a href="#" data-transition="none">修改密码</a></span>
							</div>
						</div>
					</div>
				</section>
			<div class="footer-banner" style="width:728px; margin:30px auto"></div>
			</div><!-- /container -->

			<!-- The new page dummy; this would be dynamically loaded content -->
			<div class="container" id="page-2">
				<section>		
					<ion-header-bar class="bar-positive">
						<div class="buttons">
				    	<button class="button button-icon icon ion-ios-minus-empty"
				          ng-click="data.showDelete = !data.showDelete; data.showReorder = false"></button>
				  	</div>
							<h1 class="title">云灯控制</h1>
						<div class="buttons">
				    	<button class="button button-icon icon ion-ios-plus-empty" 
				    		ng-click="showPopup_Add()"></button>
				    	<button class="button button-icon icon ion-ios-drag" 
				    		ng-click="data.showDelete = false; data.showReorder = !data.showReorder"></button>
				  	</div>
					</ion-header-bar>
					<ion-content>
						
						<ion-refresher on-refresh="doRefresh()"
						               pulling-text="Pull to refresh..." 
						               refreshing-text="Refreshing!"
						               refreshing-icon="ion-loading-b">
							
						</ion-refresher>
						<ion-list can-swipe="listCanSwipe"  show-delete="data.showDelete" show-reorder="data.showReorder">	
							<ion-item ng-repeat="item in items" ng-click="CtrlDevice(item)">					
								<span class="size-32">
									<i ng-if="item.light_state==1" class="icon ion-ios-lightbulb-outline positive"></i>
									<i ng-if="item.light_state==0" class="icon ion-ios-lightbulb-outline dark"></i>
								</span>
									<i ng-if="item.light_state==1" class="positive">&nbsp&nbsp&nbsp{{item.light_alias}}</i>
									<i ng-if="item.light_state==0" class="dark">&nbsp&nbsp&nbsp{{item.light_alias}}</i>
								
								<ion-delete-button class="ion-ios-minus" ng-click="showPopup_Delete(item)"></ion-delete-button>
								<ion-option-button class="button-dark" ng-click="showPopup_Edit(item)">
								编辑
								</ion-option-button>
								<ion-option-button class="button-assertive" ng-click="MatchDevice(item)">
								配对
								</ion-option-button>
								<ion-reorder-button class="ion-navicon" on-reorder="moveItem(item, $fromIndex, $toIndex)"></ion-reorder-button>
							</ion-item>
						</ion-list>
					</ion-content>
				</section>
			</div><!-- /container -->
			
			
				<!-- The new page dummy; this would be dynamically loaded content -->
			<div class="container" id="page-3">
				<section>		
					<ion-header-bar class="bar-positive">
							<h1 class="title">云灯控制</h1>
					</ion-header-bar>
					<ion-content>
						
						<ion-refresher on-refresh="doRefresh()"
						               pulling-text="Pull to refresh..." 
						               refreshing-text="Refreshing!"
						               refreshing-icon="ion-loading-b">
							
						</ion-refresher>
						<ion-list>	
							<ion-item ng-repeat="item in items" ng-click="CtrlDevice(item)">					
								<span class="size-32">
									<i ng-if="item.light_state==1" class="icon ion-ios-lightbulb-outline positive"></i>
									<i ng-if="item.light_state==0" class="icon ion-ios-lightbulb-outline dark"></i>
								</span>
									<i ng-if="item.light_state==1" class="positive">&nbsp&nbsp&nbsp{{item.light_alias}}</i>
									<i ng-if="item.light_state==0" class="dark">&nbsp&nbsp&nbsp{{item.light_alias}}</i>
								
							</ion-item>
						</ion-list>
					</ion-content>
				</section>
			</div><!-- /container -->

			<div id="loader" class="pageload-overlay" data-opening="M20,15 50,30 50,30 30,30 Z;M0,0 80,0 50,30 20,45 Z;M0,0 80,0 60,45 0,60 Z;M0,0 80,0 80,60 0,60 Z" data-closing="M0,0 80,0 60,45 0,60 Z;M0,0 80,0 50,30 20,45 Z;M20,15 50,30 50,30 30,30 Z;M30,30 50,30 50,30 30,30 Z">
				<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 80 60" preserveAspectRatio="none">
					<path d="M30,30 50,30 50,30 30,30 Z"/>
				</svg>
			</div><!-- /pageload-overlay -->
		</div><!-- /pagewrap -->
	
		
		<script src="js/classie.js"></script>
		<script src="js/svgLoader.js"></script>
		<script src="./js/mqttws31.js"></script>
		<script>
			
			
	function msgbox(title,content,func,cancel,focus,icon){
		/*		
		参数列表说明:
		title :弹出对话框的标题,标题内容最好在25个字符内,否则会导致显示图片的异常															
		text  :弹出对话框的内容,可以使用HTML代码,例如<font color='red'>删除么?</font>,如果直接带入函数,注意转义
		func  :弹出对话框点击确认后执行的函数,需要写全函数的引用,例如add(),如果直接带入函数,注意转义。
		cancel:弹出对话框是否显示取消按钮,为空的话不显示,为1时显示
		focus :弹出对话框焦点的位置,0焦点在确认按钮上,1在取消按钮上,为空时默认在确认按钮上
		icon  :弹出对话框的图标
		Author:Jedliu
		Blog  :Jedliu.cublog.cn 
		【网页转载请保留版权信息,实际使用时可以除去该信息】
		*/	
		icon="msgbox_"+icon+".png";
		create_mask();
		var temp="<div style=\"width:300px;border: 2px solid #ffff;background-color: #fff; font-weight: bold;font-size: 12px;\" >"
				+"<div style=\"line-height:25px; padding:0px 5px;	background-color: #3DB481;\">"+title+"</div>"
				+"<div style=\"background-color: #fff; font-weight: bold;font-size: 12px;padding:20px 0px ; text-align:center;\">"+content
				+"</div>"
				+"<div style=\"text-align:center; padding:0px 0px 20px;background-color: #fff;\"><input type='button'  style=\"border:1px solid #3DB481; background-color:#3DB481; color:#fff; width:50px; height:25px;\" value='确定'id=\"msgconfirmb\"   onclick=\"remove();"+func+";\">";
		if(null!=cancel){temp+="&nbsp;&nbsp;&nbsp;<input type='button' style=\"border:1px solid #CCC; background-color:#CCC; width:50px; height:25px;\" value='取消'  id=\"msgcancelb\"   onClick='remove()'>";}
		temp+="</div></div>";
		create_msgbox(400,200,temp);
		if(focus==0||focus=="0"||null==focus){document.getElementById("msgconfirmb").focus();}
		else if(focus==1||focus=="1"){document.getElementById("msgcancelb").focus();}			
	}
	function get_width(){
		return (document.body.clientWidth+document.body.scrollLeft);
	}
	function get_height(){
		return (document.body.clientHeight+document.body.scrollTop);
	}
	function get_left(w){
		var bw=document.body.clientWidth;
		var bh=document.body.clientHeight;
		w=parseFloat(w);
		return (bw/2-w/2+document.body.scrollLeft);
	}
	function get_top(h){
		var bw=document.body.clientWidth;
		var bh=document.body.clientHeight;
		h=parseFloat(h);
		return (bh/2-h/2+document.body.scrollTop);
	}
	function create_mask(){//创建遮罩层的函数
		var mask=document.createElement("div");
		mask.id="mask";
		mask.style.position="absolute";
		mask.style.filter="progid:DXImageTransform.Microsoft.Alpha(style=4,opacity=25)";//IE的不透明设置
		mask.style.opacity=0.4;//Mozilla的不透明设置
		mask.style.background="black";
		mask.style.top="0px";
		mask.style.left="0px";
		mask.style.width=get_width();
		mask.style.height=get_height();
		mask.style.zIndex=1000;
		document.body.appendChild(mask);
	}
	function create_msgbox(w,h,t){//创建弹出对话框的函数
		var box=document.createElement("div")	;
		box.id="msgbox";
		box.style.position="absolute";
		box.style.width=w;
		box.style.height=h;
		box.style.overflow="visible";
		box.innerHTML=t;
		box.style.zIndex=1001;
		document.body.appendChild(box);
		re_pos();
	}
	function re_mask(){
		/*
		更改遮罩层的大小,确保在滚动以及窗口大小改变时还可以覆盖所有的内容
		*/
		var mask=document.getElementById("mask")	;
		if(null==mask)return;
		mask.style.width=get_width()+"px";
		mask.style.height=get_height()+"px";
	}
	function re_pos(){
		/*
		更改弹出对话框层的位置,确保在滚动以及窗口大小改变时一直保持在网页的最中间
		*/
		var box=document.getElementById("msgbox");
		if(null!=box){
			var w=box.style.width;
			var h=box.style.height;
			box.style.left=get_left(w)+"px";
			box.style.top=get_top(h)+"px";
		}
	}
	function remove(){
		/*
		清除遮罩层以及弹出的对话框
		*/
		var mask=document.getElementById("mask");
		var msgbox=document.getElementById("msgbox");
		if(null==mask&&null==msgbox)return;
		document.body.removeChild(mask);
		document.body.removeChild(msgbox);
	}
	
	function re_show(){
		/*
		重新显示遮罩层以及弹出窗口元素
		*/
		re_pos();
		re_mask();	
	}
	function load_func(){
		/*
		加载函数,覆盖window的onresize和onscroll函数
		*/
		window.onresize=re_show;
		window.onscroll=re_show;	
	}
			

			var GB2312UnicodeConverter = {
		    ToUnicode: function (str) {
		        return escape(str).toLocaleLowerCase().replace(/%u/gi, '\\u');
		    }
		    , ToGB2312: function (str) {
		        return unescape(str.replace(/\\u/gi, '%u'));
		    }
			};
	
	    // 从url中获取某个参数的值
	    function getParameterByName(name) {
	        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
	        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
	    }
	    
	    var LoadPage = 0;
	    
	    // 得到设备ID
	    var device_id = getParameterByName('device_id');
	    var client;
	    // 如果设备ID不为空，则执行连接MQTT的操作
	    if ( device_id !== null ){
	        ez_connect(device_id);
	    }
	  // function dump_obj(myObject) {
	    //     var s = '';
	    //     for (var property in myObject) {
	    //         s += '<span>' + property +": " + myObject[property] + '</span>';
	    //     }
	    //     return s;
	    // }
	
	    // 连接MQTT服务
	    function ez_connect(device_id) {
	        // 获取access_token
	        // access_token是公众号的全局唯一票据，公众号调用各接口时都需使用access_token。
	        // 正常情况下access_token有效期为7200秒，重复获取将导致上次获取的access_token失效
	        var access_token = getParameterByName('access_token');
	
	        document.getElementById('device_id').innerHTML = device_id;
	
	        // websocket连接
	        // wsbroker:host
	        // wsport:端口 默认1983
	        // Client-ID ： v1_web_[MAC]  //版本号_app_手机MAC(必须是12位小写)
	        var wsbroker = "api.easylink.io";  //mqtt websocket enabled broker
	        var wsport = 1983 // port for above
	        client = new Paho.MQTT.Client(wsbroker, wsport, "v1-web-" + parseInt(Math.random() * 1000000, 12));
	
	        // 基本参数配置
	        // 连接丢失所对应的callback函数
	        client.onConnectionLost = onConnectionLost;
	        // 消息到达所对应的callback函数
	        client.onMessageArrived = onMessageArrived;
	        // 连接成功所对应的callback函数
	        client.connect({onSuccess:onConnect});
	      }
	
	        // 连接成功
	        function onConnect() {
	            var subtopic = device_id+'/out/#';
	            // Once a connection has been made, make a subscription and send a message.
	            // 向某个通道发送指令
	            // topic：通道
	            // commond：指令
	            client.publish = function(topic, commond) {
	                message = new Paho.MQTT.Message(commond);
	                message.destinationName = topic;
	                client.send(message);
	            }
	            client.subscribe(subtopic, {qos: 0});
	        }
	        // 连接丢失
	        function onConnectionLost(responseObject) {
	            if (responseObject.errorCode !== 0){
	            }
	        }
	        // 消息到达
	        function onMessageArrived(message) {
	        }
	        
	        function light_ctrl(light_id, light_flag){	        	
	            var topic = device_id+'/in/write';
	            var commond = "["+light_id+","+light_flag+"]";
	            client.publish(topic, commond);
	        }
	        
	        function led_red() {
	            var topic = device_id+'/in/write';
	            var commond = '{"rgbled_switch":true,"rgbled_hues":0, "rgbled_saturation":100, "rgbled_brightness":100}'; 
	            client.publish(topic, commond);
	        }
	
	        function led_green() {
	            var topic = device_id+'/in/write';
	            var commond = '{"rgbled_switch":true,"rgbled_hues":120, "rgbled_saturation":100, "rgbled_brightness":100}'; 
	            client.publish(topic, commond);
	        }
	
	        function led_blue() {
	            var topic = device_id+'/in/write';
	            var commond = '{"rgbled_switch":true,"rgbled_hues":240, "rgbled_saturation":100, "rgbled_brightness":100}'; 
	            client.publish(topic, commond);
	        }        
	        
	        function led_off() {
	            var topic = device_id+'/in/write';
	            var commond = '{"rgbled_switch":false}'; 
	            client.publish(topic, commond);
	        }
	        function SendBufToDevice(tmpbuf) {
	            var topic = device_id+'/in/write';
	            client.publish(topic, tmpbuf);
	        }
	        
	        function RevBufFromDevice(tmpbuf) {
	            var topic = device_id+'/in/write';
	            client.publish(topic, tmpbuf);
	        }
	//    }
	
				
				function CheckUser() {
					var user = document.getElementById("login_user").value;
					if(user == "admin")
					{
						LoadPage = 1;
					}
					else if(user == "guest")
					{
						LoadPage = 2;
					}
					else
					{
						LoadPage = 0;
					}
				}
	
					(function() {
					var pageWrap = document.getElementById( 'pagewrap' ),
						pages = [].slice.call( pageWrap.querySelectorAll( 'div.container' ) ),
						currentPage = 0,
						triggerLoading = [].slice.call( pageWrap.querySelectorAll( 'div.pageload-link' ) ),
						loader = new SVGLoader( document.getElementById( 'loader' ), { speedIn : 100 } );
	
	
					function init() {
						triggerLoading.forEach( function( trigger ) {
							trigger.addEventListener( 'click', function( ev ) {
								ev.preventDefault();
								CheckUser();
								if(LoadPage == 0)
								{	
									//alert("用户名或密码错误!");	
									msgbox('提示','用户名或密码错误!','',null,0,'Warning')	
									return;
								}
								loader.show();
								// after some time hide loader
								setTimeout( function() {
									loader.hide();
	
									classie.removeClass( pages[ currentPage ], 'show' );
									// update..
									CheckUser();
									currentPage = LoadPage;
									classie.addClass( pages[ currentPage ], 'show' );
	
								}, 2000 );
							} );
						} );	
					}
					init();
				})();
				
		</script>		
	</body>
</html>