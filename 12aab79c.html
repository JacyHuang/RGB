<html ng-app="ionicApp">

	<head>
		<meta charset="utf-8" id="device_id">

		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>

		<title>HomeLink</title>

			<link rel="stylesheet" type="text/css" href="./css/api.css"/>
		<link rel="stylesheet" type="text/css" href="./css/login.css"/>
		<link rel="stylesheet" type="text/css" href="./css/jquery.mobile.min.css"/>
		<script type="text/javascript" src="./js/jquery-2.1.3.js"></script>
		<script type="text/javascript" src="./js/jquery.mobile-1.4.5.min.js"></script>
		<script type="text/javascript" src="./js/api.js"></script>
		
		 <link href="http://api.easylink.io/bower_components/ionic/css/ionic.min.css" rel="stylesheet">
  <script src="http://api.easylink.io/bower_components/ionic/js/ionic.bundle.min.js"></script>
	<script type="text/javascript" src="js/new_file2.js"></script>
	
	<link rel="stylesheet" type="text/css" href="css/component.css" />
	<script src="js/snap.svg-min.js"></script>
	
	<style>
		    .size-12 { font-size: 12px; }
    .size-14 { font-size: 14px; }
    .size-16 { font-size: 16px; }
    .size-18 { font-size: 18px; }
    .size-21 { font-size: 21px; }
    .size-24 { font-size: 24px; }
    .size-32 { font-size: 32px; }
    .size-48 { font-size: 48px; }
    .size-64 { font-size: 64px; }
    .size-96 { font-size: 96px; }
    
    </style>

	</head>

	<body ng-controller="MyCtrl" style="background: url(./image/login.png) 50% 0 no-repeat;background-size: cover;">
	
		<div class="login" data-role="page" data-theme="f" id="loginpage">
			<div class="logocls" align="center">
				<img src="./image/login-micokit.svg" />
			</div>
			<div class="content">
				<div class="phone" >
					<img class="pi"  src="./image/account-tx.svg"/>
					<input class="styled" type="text" data-theme="f" data-role="none" placeholder="手机号码" id="login_phone">
				</div>
				<div class="psw ">
					<img class="pi"  src="./image/account-cd.svg"/>
					<input class="styled" type="password" data-theme="f" data-role="none" placeholder="请输入六位密码" id="login_psw">
				</div>
				<div class="subbutton" onclick="changpswtag('test')">
					<span><a href="#">登录</a></span>
				</div>
				<div class="forgotpsw">
					<a href="#registerpage" data-transition="none">忘记密码？</a>
				</div>
			</div>
			<div class="toregistcls">
				<div class="toregistbtn" onclick="changpswtag('registerpage')">
					<span ><a href="#" data-transition="none">注册</a></span>
				</div>
			</div>
		</div>

		<!--注册页面-->
		<div class="register" data-role="page" data-theme="f" id="registerpage">
			<ion-header-bar class="bar-positive">
						<div class="buttons">
				    	<button class="button button-icon icon ion-ios-minus-empty"
				          ng-click="data.showDelete = !data.showDelete; data.showReorder = false"></button>
				  	</div>
							<h1 class="title">云灯控制</h1>
						<div class="buttons">
				    	<button class="button button-icon icon ion-ios-plus-empty" 
				    		ng-click="showPopup_Add()"></button>
				    	<button class="button button-icon icon ion-ios-drag" 
				    		ng-click="data.showDelete = false; data.showReorder = !data.showReorder"></button>
				  	</div>
					</ion-header-bar>
					<ion-content>
						
						<ion-refresher on-refresh="doRefresh()"
						               pulling-text="Pull to refresh..." 
						               refreshing-text="Refreshing!"
						               refreshing-icon="ion-loading-b">
							
						</ion-refresher>
						<ion-list can-swipe="listCanSwipe"  show-delete="data.showDelete" show-reorder="data.showReorder">	
							<ion-item ng-repeat="item in items" ng-click="CtrlDevice(item)">					
								<span class="size-32">
									<i ng-if="item.light_state==1" class="icon ion-ios-lightbulb-outline positive"></i>
									<i ng-if="item.light_state==0" class="icon ion-ios-lightbulb-outline dark"></i>
								</span>
									<i ng-if="item.light_state==1" class="positive">&nbsp&nbsp&nbsp{{item.light_alias}}</i>
									<i ng-if="item.light_state==0" class="dark">&nbsp&nbsp&nbsp{{item.light_alias}}</i>
								
								<ion-delete-button class="ion-ios-minus" ng-click="showPopup_Delete(item)"></ion-delete-button>
								<ion-option-button class="button-dark" ng-click="showPopup_Edit(item)">
								编辑
								</ion-option-button>
								<ion-option-button class="button-assertive" ng-click="MatchDevice(item)">
								配对
								</ion-option-button>
								<ion-reorder-button class="ion-navicon" on-reorder="moveItem(item, $fromIndex, $toIndex)"></ion-reorder-button>
							</ion-item>
						</ion-list>
					</ion-content>
		</div>
		
			<div class="register" data-role="page" data-theme="f" id="test">
			<ion-header-bar class="bar-positive">
							<h1 class="title">云灯控制</h1>
					</ion-header-bar>
					<ion-content>
						
						<ion-refresher on-refresh="doRefresh()"
						               pulling-text="Pull to refresh..." 
						               refreshing-text="Refreshing!"
						               refreshing-icon="ion-loading-b">
							
						</ion-refresher>
						<ion-list can-swipe="listCanSwipe"  show-delete="data.showDelete" show-reorder="data.showReorder">	
							<ion-item ng-repeat="item in items" ng-click="CtrlDevice(item)">					
								<span class="size-32">
									<i ng-if="item.light_state==1" class="icon ion-ios-lightbulb-outline positive"></i>
									<i ng-if="item.light_state==0" class="icon ion-ios-lightbulb-outline dark"></i>
								</span>
									<i ng-if="item.light_state==1" class="positive">&nbsp&nbsp&nbsp{{item.light_alias}}</i>
									<i ng-if="item.light_state==0" class="dark">&nbsp&nbsp&nbsp{{item.light_alias}}</i>
								
								<ion-option-button class="button-dark" ng-click="showPopup_Edit(item)">
								编辑
								</ion-option-button>
								<ion-option-button class="button-assertive" ng-click="MatchDevice(item)">
								配对
								</ion-option-button>

							</ion-item>
						</ion-list>
					</ion-content>
		</div>
		
		
		
		
		<!--下一步-->
		<div class="nextstep" data-role="page" data-theme="f" id="nextsteppage">
			<div class="logocls" align="center">
				<img src="../image/login-micokit.svg" />
			</div>
			<div class="content">
				<div class="phone">
					<img class="pi"  src="../image/01-password-1-01.svg"/>
					<input class="styled" type="password" data-theme="f" data-role="none" placeholder="密码" id="nextstep_psw"/>
				</div>
				<div class="psw">
					<img class="pi"  src="../image/01-password-confirm-01.svg"/>
					<input class="styled" type="password" data-theme="f" data-role="none" placeholder="确定密码" id="nextstep_ckpsw"/>
				</div>
				<div class="subbutton" id="finishregister">
					<span><a href="#">完成</a></span>
				</div>
			</div>
		</div>
	
		<input id="pswtag" type="hidden" value="0" />	
		
		<script src="./js/classie.js"></script>
		<script src="./js/svgLoader.js"></script>
		<script src="./js/mqttws31.js"></script>
		
			<script>
		//	首页登录样式控制
		var screenH = document.body.clientHeight;
		var screenW = document.body.clientWidth;
		var logoclsH = 0.3 * screenH;
		$('.logocls').css('height', logoclsH);
		$('.logocls img').css('height', 0.5 * logoclsH).css('margin-top', 0.3 * logoclsH);
		$('.content').css('height', 0.5 * screenH);
	
	
		
		// 判断是忘记密码还是新用户注册
		function changpswtag(tag) {
			var header = $api.byId('pswtag');
			var tagval;
			$.mobile.changePage("#" + tag + "", {
				transition : "none"
			});
			if ("registerpage" == tag) {
				tagval = 1;
			} else {
				tagval = 0;
			}
			$api.val(header, tagval);
		}
	</script>
	
	
		<script>

			var GB2312UnicodeConverter = {
		    ToUnicode: function (str) {
		        return escape(str).toLocaleLowerCase().replace(/%u/gi, '\\u');
		    }
		    , ToGB2312: function (str) {
		        return unescape(str.replace(/\\u/gi, '%u'));
		    }
			};
	
	    // 从url中获取某个参数的值
	    function getParameterByName(name) {
	        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
	        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
	    }
	    // 得到设备ID
	    var device_id = getParameterByName('device_id');
	    var client;
	    // 如果设备ID不为空，则执行连接MQTT的操作
	    if ( device_id !== null ){
	        ez_connect(device_id);
	    }
	  // function dump_obj(myObject) {
	    //     var s = '';
	    //     for (var property in myObject) {
	    //         s += '<span>' + property +": " + myObject[property] + '</span>';
	    //     }
	    //     return s;
	    // }
	
	    // 连接MQTT服务
	    function ez_connect(device_id) {
	        // 获取access_token
	        // access_token是公众号的全局唯一票据，公众号调用各接口时都需使用access_token。
	        // 正常情况下access_token有效期为7200秒，重复获取将导致上次获取的access_token失效
	        var access_token = getParameterByName('access_token');
	
	        document.getElementById('device_id').innerHTML = device_id;
	
	        // websocket连接
	        // wsbroker:host
	        // wsport:端口 默认1983
	        // Client-ID ： v1_web_[MAC]  //版本号_app_手机MAC(必须是12位小写)
	        var wsbroker = "api.easylink.io";  //mqtt websocket enabled broker
	        var wsport = 1983 // port for above
	        client = new Paho.MQTT.Client(wsbroker, wsport, "v1-web-" + parseInt(Math.random() * 1000000, 12));
	
	        // 基本参数配置
	        // 连接丢失所对应的callback函数
	        client.onConnectionLost = onConnectionLost;
	        // 消息到达所对应的callback函数
	        client.onMessageArrived = onMessageArrived;
	        // 连接成功所对应的callback函数
	        client.connect({onSuccess:onConnect});
	      }
	
	        // 连接成功
	        function onConnect() {
	            var subtopic = device_id+'/out/#';
	            // Once a connection has been made, make a subscription and send a message.
	            // 向某个通道发送指令
	            // topic：通道
	            // commond：指令
	            client.publish = function(topic, commond) {
	                message = new Paho.MQTT.Message(commond);
	                message.destinationName = topic;
	                client.send(message);
	            }
	            client.subscribe(subtopic, {qos: 0});
	        }
	        // 连接丢失
	        function onConnectionLost(responseObject) {
	            if (responseObject.errorCode !== 0){
	            }
	        }
	        // 消息到达
	        function onMessageArrived(message) {
	        }
	        
	        function light_ctrl(light_id, light_flag){	        	
	            var topic = device_id+'/in/write';
	            var commond = "["+light_id+","+light_flag+"]";
	            client.publish(topic, commond);
	        }
	        
	        function led_red() {
	            var topic = device_id+'/in/write';
	            var commond = '{"rgbled_switch":true,"rgbled_hues":0, "rgbled_saturation":100, "rgbled_brightness":100}'; 
	            client.publish(topic, commond);
	        }
	
	        function led_green() {
	            var topic = device_id+'/in/write';
	            var commond = '{"rgbled_switch":true,"rgbled_hues":120, "rgbled_saturation":100, "rgbled_brightness":100}'; 
	            client.publish(topic, commond);
	        }
	
	        function led_blue() {
	            var topic = device_id+'/in/write';
	            var commond = '{"rgbled_switch":true,"rgbled_hues":240, "rgbled_saturation":100, "rgbled_brightness":100}'; 
	            client.publish(topic, commond);
	        }        
	        
	        function led_off() {
	            var topic = device_id+'/in/write';
	            var commond = '{"rgbled_switch":false}'; 
	            client.publish(topic, commond);
	        }
	        function SendBufToDevice(tmpbuf) {
	            var topic = device_id+'/in/write';
	            client.publish(topic, tmpbuf);
	        }
	        
	        function RevBufFromDevice(tmpbuf) {
	            var topic = device_id+'/in/write';
	            client.publish(topic, tmpbuf);
	        }
	//    }
	
	
					(function() {
					var pageWrap = document.getElementById( 'pagewrap' ),
						pages = [].slice.call( pageWrap.querySelectorAll( 'div.container' ) ),
						currentPage = 0,
						triggerLoading = [].slice.call( pageWrap.querySelectorAll( 'div.pageload-link' ) ),
						loader = new SVGLoader( document.getElementById( 'loader' ), { speedIn : 100 } );
	
					function init() {
						triggerLoading.forEach( function( trigger ) {
							trigger.addEventListener( 'click', function( ev ) {
								ev.preventDefault();
								loader.show();
								// after some time hide loader
								setTimeout( function() {
									loader.hide();
	
									classie.removeClass( pages[ currentPage ], 'show' );
									// update..
									currentPage = currentPage ? 0 : 1;
									classie.addClass( pages[ currentPage ], 'show' );
	
								}, 2000 );
							} );
						} );	
					}
	
					init();
				})();

		</script>	
	</body>
</html>