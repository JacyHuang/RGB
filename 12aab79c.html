<!DOCTYPE html>
<html ng-app="ionicApp">
<head>
    <meta charset="gb2312" id="device_id">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width" />
    <title>HomeLink</title>
    	<link rel="stylesheet" type="text/css" href="css/default.css">
    <link href="docs/css/highlight.css" rel="stylesheet">
    <link href="css/bootstrap3/bootstrap-switch.css" rel="stylesheet">
    <link href="docs/css/main.css" rel="stylesheet">
    <link href="docs/css/header.css" rel="stylesheet">
      <link href="http://api.easylink.io/bower_components/ionic/css/ionic.min.css" rel="stylesheet">
  <script src="http://api.easylink.io/bower_components/ionic/js/ionic.bundle.min.js"></script>
        <script type="text/javascript">
    function getParameterByName(name) {
      var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
      return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
    }
    var access_token = getParameterByName('access_token');
    var device_list = [];
    
    var deviceLists = getParameterByName('device_list');
    if ( deviceLists !== null ){
      try {
        deviceLists = JSON.parse(deviceLists);
        
        for ( var i in deviceLists ) {
          var device = deviceLists[i];
          if ( device[0] === null ) continue;
          var product_id = device[0].split('/')[0];
          var alias = device[3] ? device[3] : device[0];
          device_list.push({'alias': alias, 'device_id': device[0], 'product_id': product_id, 'time': new Date(parseInt(device[1])*1000).toLocaleString(), 'state': device[2]});
        }
      } catch(e) {
        alert(e);
      }
    }

    angular.module('ionicApp', ['ionic'])
    .controller('MyCtrl', function($scope, $ionicPopup, $ionicListDelegate, $http) {
      $scope.items = device_list;
      $scope.access_token = access_token;
      
      $scope.data = {
        showDelete: false
      };
      $scope.listCanSwipe = true;
      $scope.showPopup = function(item) {
        var index = $scope.items.indexOf(item);
        $scope.data = {}

          // An elaborate, custom popup
          var myPopup = $ionicPopup.show({
            template: '<input type="text" ng-model="data.alias">',
            title: '',
            subTitle: 'ÐÞ¸ÄÃû³Æ',
            scope: $scope,
            buttons: [
            { text: 'Cancel' },
            {
              text: '<b>Save</b>',
              type: 'button-positive',
              onTap: function(e) {
                if (!$scope.data.alias) {
                  e.preventDefault();
                } else {
                  $http.post(
                    'http://api.easylink.io/v1/device/modify',
                    {
                      device_id : item.device_id,
                      alias     : $scope.data.alias
                    }, {
                      headers : {
                        'AUTHORIZATION' : "token " + access_token
                      }
                    } 
                    ).success(function(data) {
                      $scope.items[index].alias = $scope.data.alias;
                      $ionicListDelegate.closeOptionButtons();

                    }).error(function(data){
                      alert(data.error.message);
                      return; 
                    });  
                  }
                }
              }
              ]
            });
};

$scope.reloadPage = function() {
 $http.post(
   'http://api.easylink.io/v1/device/devices',
   null,{
     headers : {
       'AUTHORIZATION' : "token " + access_token
     }
   }
   ).success(function(data) {
    $scope.items = [];
    for ( var i in data ) {
      var device = data[i];
      if ( device === null ) continue;
      var product_id = device.id.split('/')[0];
      var alias = device.alias ? device.alias : device.id;
      $scope.items.push({'alias': alias, 'device_id': device.id, 'product_id': product_id, 'time': device.created, 'state': device.online});
    }
  }).error(function(data) {
   alert(data.error.message);
   return;
 });
};
});
</script>
    <style type="text/css">
	    	* {
					margin: 0px;
					padding: 0px;
				}
				body {
					background-color: #EBEBEB;
					background-size: cover;
					font-family: "ºÚÌå";
					font-size: 13px;
				}
				.content {
					margin: 1px;
					padding: 1px;
				}
				.title {
					margin: 10px 12px 5px 12px;
					background-color: #FFFFFF;
					text-align: center;
					padding: 7px 0;
					box-shadow: 3px 3px 3px #e1e1e1;
				}
				.title span {
					color: #000000;
					font-size: 18px;
					position: relative;
				}
        .button {
				display: inline-block;
				outline: none;
				cursor: pointer;
				text-align: center;
				text-decoration: none;
				font: 16px/100% 'Microsoft yahei',Arial, Helvetica, sans-serif;
				padding: .5em 2em .55em;
				text-shadow: 0 1px 1px rgba(0,0,0,.3);
				-webkit-border-radius: .5em; 
				-moz-border-radius: .5em;
				border-radius: .5em;
				-webkit-box-shadow: 0 1px 2px rgba(0,0,0,.2);
				-moz-box-shadow: 0 1px 2px rgba(0,0,0,.2);
				box-shadow: 0 1px 2px rgba(0,0,0,.2);
			}
			.button:hover {
				text-decoration: none;
			}
			.button:active {
				position: relative;
				top: 1px;
			}
			.bigrounded {
				-webkit-border-radius: 2em;
				-moz-border-radius: 2em;
				border-radius: 2em;
			}
			.medium {
				font-size: 12px;
				padding: .4em 1.5em .42em;
			}
			.small {
				font-size: 11px;
				padding: .2em 1em .275em;
			}
			
			
			/* blue */
			.blue {
				color: #d9eef7;
				border: solid 1px #0076a3;
				background: #0095cd;
				background: -webkit-gradient(linear, left top, left bottom, from(#00adee), to(#0078a5));
				background: -moz-linear-gradient(top,  #00adee,  #0078a5);
				filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#00adee', endColorstr='#0078a5');
			}
			.blue:hover {
				background: #007ead;
				background: -webkit-gradient(linear, left top, left bottom, from(#0095cc), to(#00678e));
				background: -moz-linear-gradient(top,  #0095cc,  #00678e);
				filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#0095cc', endColorstr='#00678e');
			}
			.blue:active {
				color: #80bed6;
				background: -webkit-gradient(linear, left top, left bottom, from(#0078a5), to(#00adee));
				background: -moz-linear-gradient(top,  #0078a5,  #00adee);
				filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#0078a5', endColorstr='#00adee');
			}
			
			/* green */
			.green {
				color: #e8f0de;
				border: solid 1px #538312;
				background: #64991e;
				background: -webkit-gradient(linear, left top, left bottom, from(#7db72f), to(#4e7d0e));
				background: -moz-linear-gradient(top,  #7db72f,  #4e7d0e);
				filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#7db72f', endColorstr='#4e7d0e');
			}
			.green:hover {
				background: #538018;
				background: -webkit-gradient(linear, left top, left bottom, from(#6b9d28), to(#436b0c));
				background: -moz-linear-gradient(top,  #6b9d28,  #436b0c);
				filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#6b9d28', endColorstr='#436b0c');
			}
			.green:active {
				color: #a9c08c;
				background: -webkit-gradient(linear, left top, left bottom, from(#4e7d0e), to(#7db72f));
				background: -moz-linear-gradient(top,  #4e7d0e,  #7db72f);
				filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#4e7d0e', endColorstr='#7db72f');
			}
			
			/* white */
			.white {
				color: #606060;
				border: solid 1px #b7b7b7;
				background: #fff;
				background: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#ededed));
				background: -moz-linear-gradient(top,  #fff,  #ededed);
				filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffff', endColorstr='#ededed');
			}
			.white:hover {
				background: #ededed;
				background: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#dcdcdc));
				background: -moz-linear-gradient(top,  #fff,  #dcdcdc);
				filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffff', endColorstr='#dcdcdc');
			}
			.white:active {
				color: #999;
				background: -webkit-gradient(linear, left top, left bottom, from(#ededed), to(#fff));
				background: -moz-linear-gradient(top,  #ededed,  #fff);
				filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#ededed', endColorstr='#ffffff');
			}
			
			/* orange */
			.orange {
				color: #fef4e9;
				border: solid 1px #da7c0c;
				background: #f78d1d;
				background: -webkit-gradient(linear, left top, left bottom, from(#faa51a), to(#f47a20));
				background: -moz-linear-gradient(top,  #faa51a,  #f47a20);
				filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#faa51a', endColorstr='#f47a20');
			}
			.orange:hover {
				background: #f47c20;
				background: -webkit-gradient(linear, left top, left bottom, from(#f88e11), to(#f06015));
				background: -moz-linear-gradient(top,  #f88e11,  #f06015);
				filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#f88e11', endColorstr='#f06015');
			}
			.orange:active {
				color: #fcd3a5;
				background: -webkit-gradient(linear, left top, left bottom, from(#f47a20), to(#faa51a));
				background: -moz-linear-gradient(top,  #f47a20,  #faa51a);
				filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#f47a20', endColorstr='#faa51a');
			}

    </style>
</head>
<body>	
</ion-header-bar>
<ion-content>
<ion-list can-swipe="listCanSwipe"  show-delete="data.showDelete" show-reorder="data.showReorder">
<ion-item ng-repeat="item in items" 
item="item"
href="{{ item.product_id }}.html?device_id={{ item.device_id }}&access_token={{ access_token }}&alias={{ item.alias }}" class="item-remove-animate">
<i ng-if="item.state==1" class="icon ion-record positive" ></i><i ng-if="item.state==0" class="icon ion-record assertive" ></i> {{ item.alias }}<br>
<span class="item-note">ID : {{ item.device_id }}</span>
<ion-option-button class="button-assertive"
ng-click="showPopup(item)">
Edit
</ion-option-button>
</ion-item>
</ion-list>
</ion-content>
				<header id="header" class="header">
			<span class="center" id="device_name">ÔÆµÆ¿ØÖÆ</span>
		</header>
		<br><hr color="black"/>
				<div class="col-sm-6 col-lg-4" align="right">
			<br><input name="sw-checkbox" id="switch-state" type="checkbox" checked>
		</div>
		<br><hr color="black"/>
  <div class="bar-footer" style="bottom:0;position:absolute">


 <div class="button-bar">
     <a href="#" class="button blue" id="led_blue">À¶É«</a> 
     <a href="#" class="button green" id="led_green">ÂÌÉ«</a> 
     <a href="#" class="button orange" id="led_red">³ÈÉ«</a> 
 </div>
<br>
</div>
<script src="docs/js/jquery.min.js"></script>
<script src="docs/js/bootstrap.min.js"></script>
<script src="docs/js/highlight.js"></script>
<script src="js/bootstrap-switch.js"></script>
<script src="docs/js/main.js"></script>
<script src="http://api.easylink.io/assets/js/mqttws31.js"></script>
<script language="javascript">
    // ´ÓurlÖÐ»ñÈ¡Ä³¸ö²ÎÊýµÄÖµ
    function getParameterByName(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
    }
    // µÃµ½Éè±¸ID
    var device_id = getParameterByName('device_id');
    // Èç¹ûÉè±¸ID²»Îª¿Õ£¬ÔòÖ´ÐÐÁ¬½ÓMQTTµÄ²Ù×÷
    if ( device_id !== null ){
        ez_connect(device_id);
    }

    // function dump_obj(myObject) {
    //     var s = '';
    //     for (var property in myObject) {
    //         s += '<span>' + property +": " + myObject[property] + '</span>';
    //     }
    //     return s;
    // }

    // Á¬½ÓMQTT·þÎñ
    function ez_connect(device_id) {
        // »ñÈ¡access_token
        // access_tokenÊÇ¹«ÖÚºÅµÄÈ«¾ÖÎ¨Ò»Æ±¾Ý£¬¹«ÖÚºÅµ÷ÓÃ¸÷½Ó¿ÚÊ±¶¼ÐèÊ¹ÓÃaccess_token¡£
        // Õý³£Çé¿öÏÂaccess_tokenÓÐÐ§ÆÚÎª7200Ãë£¬ÖØ¸´»ñÈ¡½«µ¼ÖÂÉÏ´Î»ñÈ¡µÄaccess_tokenÊ§Ð§
        var access_token = getParameterByName('access_token');

        document.getElementById('device_id').innerHTML = device_id;

        // websocketÁ¬½Ó
        // wsbroker:host
        // wsport:¶Ë¿Ú Ä¬ÈÏ1983
        // Client-ID £º v1_web_[MAC]  //°æ±¾ºÅ_app_ÊÖ»úMAC(±ØÐëÊÇ12Î»Ð¡Ð´)
        var wsbroker = "api.easylink.io";  //mqtt websocket enabled broker
        var wsport = 1983 // port for above
        var client = new Paho.MQTT.Client(wsbroker, wsport, "v1-web-" + parseInt(Math.random() * 1000000, 12));

        // »ù±¾²ÎÊýÅäÖÃ
        // Á¬½Ó¶ªÊ§Ëù¶ÔÓ¦µÄcallbackº¯Êý
        client.onConnectionLost = onConnectionLost;
        // ÏûÏ¢µ½´ïËù¶ÔÓ¦µÄcallbackº¯Êý
        client.onMessageArrived = onMessageArrived;
        // Á¬½Ó³É¹¦Ëù¶ÔÓ¦µÄcallbackº¯Êý
        client.connect({onSuccess:onConnect});

        // Á¬½Ó³É¹¦
        function onConnect() {
            var subtopic = device_id+'/out/#';
            // Once a connection has been made, make a subscription and send a message.
            // ÏòÄ³¸öÍ¨µÀ·¢ËÍÖ¸Áî
            // topic£ºÍ¨µÀ
            // commond£ºÖ¸Áî
            client.publish = function(topic, commond) {
                message = new Paho.MQTT.Message(commond);
                message.destinationName = topic;
                client.send(message);
            }
            client.subscribe(subtopic, {qos: 0});
        }
        // Á¬½Ó¶ªÊ§
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0)
            {
            }
        }
        // ÏûÏ¢µ½´ï
        function onMessageArrived(message) {
        }
        $('input[name="sw-checkbox"]').on('switchChange.bootstrapSwitch', function(event, state) {
					            var check=document.getElementById("switch-state");
            var topic = device_id+'/in/write';
          var commond = '{"rgbled_switch":' + check.checked + '}';
            client.publish(topic, commond);
				});

        function led_red() {
            var topic = device_id+'/in/write';
            var commond = '{"rgbled_switch":true,"rgbled_hues":0, "rgbled_saturation":100, "rgbled_brightness":100}'; 
            client.publish(topic, commond);
        }
        // document.querySelector('#led_red').addEventListener('touchstart', led_red);
        document.querySelector('#led_red').addEventListener('click', led_red);

        function led_green() {
            var topic = device_id+'/in/write';
            var commond = '{"rgbled_switch":true,"rgbled_hues":120, "rgbled_saturation":100, "rgbled_brightness":100}'; 
            client.publish(topic, commond);
        }
        // document.querySelector('#led_green').addEventListener('touchstart', led_green);
        document.querySelector('#led_green').addEventListener('click', led_green);

        function led_blue() {
            var topic = device_id+'/in/write';
            var commond = '{"rgbled_switch":true,"rgbled_hues":240, "rgbled_saturation":100, "rgbled_brightness":100}'; 
            client.publish(topic, commond);
        }
        // document.querySelector('#led_blue').addEventListener('touchstart', led_blue);
        document.querySelector('#led_blue').addEventListener('click', led_blue);
    }
</script>
</body>
</html>
